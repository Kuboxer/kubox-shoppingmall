name: Backend MSA Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
          
      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        
      - name: Detect changed services and build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # 변경된 파일 확인
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # 변경된 서비스 찾기
          CHANGED_SERVICES=""
          
          if echo "$CHANGED_FILES" | grep -q "backend/user-service/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES user-service"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "backend/product-service/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES product-service"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "backend/order-service/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES order-service"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "backend/payment-service/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES payment-service"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "backend/cart-service/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES cart-service"
          fi
          
          CHANGED_SERVICES=$(echo $CHANGED_SERVICES | xargs)
          
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "No service changes detected. Skipping build."
            exit 0
          fi
          
          echo "Changed services: $CHANGED_SERVICES"
          
          for SERVICE in $CHANGED_SERVICES; do
            echo "=== Building $SERVICE ==="
            
            # 현재 최고 버전 찾기 (정확한 패턴 매칭)
            LATEST_VERSION=$(aws ecr describe-images \
              --repository-name kubox \
              --query "imageDetails[].imageTags[]" \
              --output text 2>/dev/null | \
              grep "^${SERVICE}-v[0-9]\+$" | \
              sed "s/${SERVICE}-v//" | \
              sort -n | \
              tail -1)
            
            # 다음 버전 결정
            if [ -z "$LATEST_VERSION" ]; then
              NEXT_VERSION=1
            else
              NEXT_VERSION=$((LATEST_VERSION + 1))
            fi
            
            echo "Latest version: v$LATEST_VERSION"
            echo "Next version: v$NEXT_VERSION"
            
            # 새 이미지 빌드
            NEW_TAG="${SERVICE}-v${NEXT_VERSION}"
            IMAGE_URI="$ECR_REGISTRY/kubox:$NEW_TAG"
            
            echo "Building new image: $IMAGE_URI"
            
            # 도커 빌드 및 푸시
            cd backend/$SERVICE
            if docker build -t $IMAGE_URI .; then
              echo "✅ Build successful"
              
              if docker push $IMAGE_URI; then
                echo "✅ Push successful: $NEW_TAG"
                
                # latest 태그 업데이트 (기존 latest는 그대로 두고 새로 생성)
                LATEST_URI="$ECR_REGISTRY/kubox:${SERVICE}-latest"
                docker tag $IMAGE_URI $LATEST_URI
                docker push $LATEST_URI
                echo "✅ Latest tag updated"
              else
                echo "❌ Push failed"
              fi
            else
              echo "❌ Build failed"
            fi
            
            cd ../..
            echo "✅ $SERVICE completed: $NEW_TAG"
            echo "---"
          done
          
      - name: Summary
        run: |
          echo "✅ Deployment completed"
          echo "Only changed services were rebuilt with incremental version tags"
