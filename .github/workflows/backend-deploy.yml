name: Backend MSA Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
          
      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        
      - name: Detect services to build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          ALL_SERVICES=("user-service" "product-service" "order-service" "payment-service" "cart-service")
          BUILD_SERVICES=""
          
          # ECRì— ì´ë¯¸ì§€ê°€ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€ í™•ì¸
          TOTAL_IMAGES=$(aws ecr describe-images \
            --repository-name kubox \
            --query "length(imageDetails)" \
            --output text 2>/dev/null || echo "0")
          
          echo "Total images in ECR: $TOTAL_IMAGES"
          
          if [ "$TOTAL_IMAGES" = "0" ]; then
            echo "ğŸ†• No images found in ECR. Building ALL services for first time."
            BUILD_SERVICES="${ALL_SERVICES[@]}"
          else
            echo "ğŸ“‹ Images exist. Checking for changed services only."
            
            # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
            echo "Changed files:"
            echo "$CHANGED_FILES"
            
            # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ì°¾ê¸°
            for SERVICE in "${ALL_SERVICES[@]}"; do
              if echo "$CHANGED_FILES" | grep -q "backend/$SERVICE/"; then
                BUILD_SERVICES="$BUILD_SERVICES $SERVICE"
              fi
            done
            
            BUILD_SERVICES=$(echo $BUILD_SERVICES | xargs)
          fi
          
          if [ -z "$BUILD_SERVICES" ]; then
            echo "No services to build. Exiting."
            exit 0
          fi
          
          echo "Services to build: $BUILD_SERVICES"
          echo "build_services=$BUILD_SERVICES" >> $GITHUB_ENV
          
      - name: Build services
        if: env.build_services != ''
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # ê³ ìœ ì„±ì„ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ (ë‚´ë¶€ ë¹Œë“œìš©)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BUILD_NUMBER="${{ github.run_number }}"
          
          # ë¹Œë“œëœ ì„œë¹„ìŠ¤ì™€ ë²„ì „ì„ ì €ì¥í•  ë°°ì—´
          BUILT_SERVICES=""
          
          for SERVICE in ${{ env.build_services }}; do
            echo "=== Processing $SERVICE ==="
            
            # í˜„ì¬ ì„œë¹„ìŠ¤ì˜ ê¸°ì¡´ ë²„ì „ í™•ì¸
            echo "Checking existing versions for $SERVICE..."
            EXISTING_VERSIONS=$(aws ecr describe-images \
              --repository-name kubox \
              --query "imageDetails[].imageTags[]" \
              --output text 2>/dev/null | \
              tr '\t' '\n' | \
              grep "^${SERVICE}-v[0-9]*$" | \
              sed "s/${SERVICE}-v//" | \
              sort -n || echo "")
            
            if [ -z "$EXISTING_VERSIONS" ]; then
              NEXT_VERSION=1
              echo "ğŸ†• No existing versions found. Creating first version: v1"
            else
              echo "ğŸ“‹ Existing versions: $(echo $EXISTING_VERSIONS | tr '\n' ' ')"
              LATEST_VERSION=$(echo "$EXISTING_VERSIONS" | tail -1)
              NEXT_VERSION=$((LATEST_VERSION + 1))
              echo "ğŸ“ˆ Latest version: v$LATEST_VERSION -> Next version: v$NEXT_VERSION"
            fi
            
            # ìµœì¢… íƒœê·¸ë“¤
            VERSION_TAG="${SERVICE}-v${NEXT_VERSION}"
            LATEST_TAG="${SERVICE}-latest"
            
            # ì„ì‹œ ê³ ìœ  íƒœê·¸ (ì¶©ëŒ ë°©ì§€ìš©)
            TEMP_TAG="${SERVICE}-temp-${TIMESTAMP}-${BUILD_NUMBER}"
            
            VERSION_URI="$ECR_REGISTRY/kubox:$VERSION_TAG"
            LATEST_URI="$ECR_REGISTRY/kubox:$LATEST_TAG"
            
            echo "ğŸ—ï¸  Building $SERVICE as $VERSION_TAG"
            
            # ë„ì»¤ ë¹Œë“œ (VERSION ì¸ì ì „ë‹¬)
            cd backend/$SERVICE
            
            if docker build --build-arg VERSION="$VERSION_TAG" -t "$TEMP_TAG" .; then
              echo "âœ… Build successful"
              
              # ë²„ì „ íƒœê·¸ ì ìš© ë° í‘¸ì‹œ
              docker tag "$TEMP_TAG" "$VERSION_URI"
              if docker push "$VERSION_URI"; then
                echo "âœ… Successfully pushed $VERSION_TAG"
                
                # latest íƒœê·¸ ì ìš© ë° í‘¸ì‹œ
                docker tag "$TEMP_TAG" "$LATEST_URI"
                docker push "$LATEST_URI"
                echo "âœ… Updated $LATEST_TAG tag"
                
                # ë¹Œë“œ ì„±ê³µí•œ ì„œë¹„ìŠ¤ ê¸°ë¡
                BUILT_SERVICES="$BUILT_SERVICES $SERVICE:$VERSION_TAG"
                
                # ê²°ê³¼ í™•ì¸
                echo "ğŸ¯ $SERVICE is now available as:"
                echo "   ğŸ“¦ $VERSION_TAG"
                echo "   ğŸ·ï¸  $LATEST_TAG"
                
              else
                echo "âŒ Failed to push $VERSION_TAG"
              fi
              
              # ì„ì‹œ íƒœê·¸ ì •ë¦¬
              docker rmi "$TEMP_TAG" 2>/dev/null || true
              
            else
              echo "âŒ Build failed for $SERVICE"
            fi
            
            cd ../..
            echo "---"
          done

          # ë¹Œë“œ ê²°ê³¼ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
          echo "built_services=$BUILT_SERVICES" >> $GITHUB_ENV
          
      - name: Update Helm Chart
        if: env.built_services != ''
        run: |
          echo "ğŸ”„ Updating Helm Chart with new image tags..."
          
          # Helm Chart ì €ì¥ì†Œ í´ë¡ 
          git clone https://github.com/Kuboxer/kubox-helm-chart.git helm-repo
          cd helm-repo
          
          # Git ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # ë¹Œë“œëœ ê° ì„œë¹„ìŠ¤ì˜ íƒœê·¸ ì—…ë°ì´íŠ¸
          for SERVICE_TAG in ${{ env.built_services }}; do
            SERVICE=$(echo $SERVICE_TAG | cut -d':' -f1)
            TAG=$(echo $SERVICE_TAG | cut -d':' -f2)
            
            echo "ğŸ“ Updating $SERVICE to $TAG"
            
            # values.yamlì—ì„œ í•´ë‹¹ ì„œë¹„ìŠ¤ì˜ íƒœê·¸ ì—…ë°ì´íŠ¸
            case $SERVICE in
              "user-service")
                sed -i "s/tag: user-service-v.*/tag: $TAG/" values.yaml
                ;;
              "product-service")
                sed -i "s/tag: product-service-v.*/tag: $TAG/" values.yaml
                ;;
              "cart-service")
                sed -i "s/tag: cart-service-v.*/tag: $TAG/" values.yaml
                ;;
              "order-service")
                sed -i "s/tag: order-service-v.*/tag: $TAG/" values.yaml
                ;;
              "payment-service")
                sed -i "s/tag: payment-service-v.*/tag: $TAG/" values.yaml
                ;;
            esac
          done
          
          # ë³€ê²½ì‚¬í•­ í™•ì¸
          echo "ğŸ“‹ Changes made:"
          git diff
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì»¤ë°‹ & í‘¸ì‹œ
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Update image tags: ${{ env.built_services }}"
            git push https://${{ secrets.HELM_REPO_TOKEN }}@github.com/Kuboxer/kubox-helm-chart.git main
            echo "âœ… Helm chart updated successfully"
          else
            echo "â„¹ï¸  No changes to commit"
          fi
          
      - name: Summary
        run: |
          echo ""
          echo "ğŸ‰ Deployment Summary:"
          echo "âœ… Built services: ${{ env.build_services }}"
          echo "ğŸ“¦ Updated images: ${{ env.built_services }}"
          echo "ğŸ“‹ Build logic:"
          echo "   - No images in ECR: Build ALL services as v1"
          echo "   - Images exist: Build only CHANGED services"
          echo "   - Latest tag always points to newest version"
          echo "   - Helm chart automatically updated"
