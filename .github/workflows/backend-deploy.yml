name: Backend MSA Deploy with Smart Detection

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

jobs:
  sonarqube-analysis:
    runs-on: ubuntu-latest
    outputs:
      analysis-result: ${{ steps.sonarqube-scan.outcome }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # SonarQubeë¥¼ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”
        
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache SonarQube packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: |
          find backend/ -name "gradlew" -exec chmod +x {} \;

      - name: Build and Test with Gradle
        run: |
          echo "ğŸ”¨ Building and testing all backend services..."
          for service in backend/*/; do
            if [ -f "$service/build.gradle" ]; then
              service_name=$(basename "$service")
              echo "ğŸ“¦ Building $service_name..."
              cd "$service"
              ./gradlew clean build -x test  # í…ŒìŠ¤íŠ¸ëŠ” ë³„ë„ë¡œ ì‹¤í–‰
              ./gradlew test --continue || true  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
              cd ../..
            fi
          done

      - name: Build services for SonarQube
        run: |
          echo "ğŸ”¨ Building services for SonarQube analysis..."
          for service in backend/*/; do
            if [ -f "$service/build.gradle" ]; then
              service_name=$(basename "$service")
              echo "ğŸ“¦ Building $service_name for analysis..."
              cd "$service"
              ./gradlew clean compileJava compileTestJava
              cd ../..
            fi
          done

      - name: Run SonarQube Scan
        id: sonarqube-scan
        run: |
          # SonarQube Scanner ë‹¤ìš´ë¡œë“œ ë° ì‹¤í–‰
          wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
          unzip -q sonar-scanner-cli-4.8.0.2856-linux.zip
          export PATH=$PATH:$(pwd)/sonar-scanner-4.8.0.2856-linux/bin
          
          # SonarQube ìŠ¤ìº” ì‹¤í–‰
          sonar-scanner \
            -Dsonar.projectKey=kubox-shopping-mall \
            -Dsonar.sources=backend \
            -Dsonar.java.binaries=backend/user-service/build/classes/java/main,backend/product-service/build/classes/java/main,backend/cart-service/build/classes/java/main,backend/order-service/build/classes/java/main,backend/payment-service/build/classes/java/main \
            -Dsonar.java.test.binaries=backend/user-service/build/classes/java/test,backend/product-service/build/classes/java/test,backend/cart-service/build/classes/java/test,backend/order-service/build/classes/java/test,backend/payment-service/build/classes/java/test \
            -Dsonar.exclusions="**/build/**,**/gradle/**,**/gradlew,**/gradlew.bat,**/.gradle/**" \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.token=${{ secrets.SONAR_TOKEN }}

      - name: ğŸ“Š Notify SonarQube Analysis Complete
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "",
              "attachments": [
                {
                  "color": "#36a64f",
                  "title": "ğŸ” SonarQube Code Analysis Completed",
                  "fields": [
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "`${{ env.SHORT_SHA }}`",
                      "short": true
                    },
                    {
                      "title": "Triggered by",
                      "value": "${{ github.actor }}",
                      "short": true
                    }
                  ],
                  "footer": "SonarQube Analysis",
                  "footer_icon": "https://docs.sonarqube.org/latest/images/favicon.ico",
                  "ts": "${{ env.TIMESTAMP }}"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}


  # ìˆ˜ë™ ìŠ¹ì¸ ë‹¨ê³„ 
  manual-approval:
    name: ğŸ” Manual Deployment Approval
    needs: sonarqube-analysis
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Display Approval Information
        run: |
          echo "ğŸ” Code Quality Analysis Complete!"
          echo "ğŸ“Š Please check SonarQube Dashboard for detailed analysis results"
          echo ""
          echo "â³ This deployment requires manual approval."
          echo "ğŸ‘¥ Approved reviewers: IluvRiver, JH2050, choiyunha"
          echo ""
          echo "ğŸ“‹ Before approving, please verify:"
          echo "  âœ… Quality Gate Status: PASSED"
          echo "  âœ… No Critical/Major Security Issues" 
          echo "  âœ… Code Coverage meets requirements"
          echo "  âœ… No Duplicated Code violations"
          echo "  âœ… Technical Debt ratio is acceptable"
          echo ""
          echo "ğŸš€ Ready to proceed with deployment!"

      - name: â³ Notify Approval Required
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "",
              "attachments": [{
                "color": "#ff9500", 
                "title": "â³ Manual Approval Required for Deployment",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Workflow",
                    "value": "${{ github.workflow }}",
                    "short": true
                  },
                  {
                    "title": "Status",
                    "value": "ğŸ” SonarQube analysis completed - Waiting for approval",
                    "short": false
                  },
                  {
                    "title": "ğŸ‘¥ Reviewers",
                    "value": "@IluvRiver @JH2050 @choiyunha",
                    "short": false
                  },
                  {
                    "title": "ğŸ“‹ Approval Checklist", 
                    "value": "â€¢ Quality Gate: PASSED\nâ€¢ No Critical Security Issues\nâ€¢ Code Coverage meets requirements\nâ€¢ Technical Debt is acceptable",
                    "short": false
                  },
                  {
                    "title": "ğŸ”— Review & Approve",
                    "value": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Click here to review and approve>",
                    "short": false
                  }
                ],
                "footer": "GitHub Actions - Manual Approval",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "ts": $(date +%s)
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ìŠ¹ì¸ í›„ ë¹Œë“œ ë° ë°°í¬
  build-and-deploy:
    name: ğŸš€ Build and Deploy
    needs: [sonarqube-analysis, manual-approval]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ğŸš€ Notify Deployment Started
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "",
              "attachments": [{
                "color": "#36a64f",
                "title": "ğŸš€ Deployment Approved - Starting Build Process",
                "fields": [
                  {
                    "title": "Repository", 
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Status",
                    "value": "âœ… Manual approval received\nğŸ—ï¸ Starting Docker image build process...",
                    "short": false
                  }
                ],
                "footer": "GitHub Actions - Build Started", 
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "ts": $(date +%s)
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
          mask-aws-account-id: false
          
      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          mask-password: true
        
      - name: ğŸ” Detect Changed Services Only
        id: detect-services
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          ALL_SERVICES=("user-service" "product-service" "order-service" "payment-service" "cart-service")
          BUILD_SERVICES=""
          
          echo "ğŸ” Smart Detection: Analyzing changed files to build ONLY modified services"
          echo ""
          
          # ì•ˆì „í•œ ë³€ê²½ íŒŒì¼ ê°ì§€
          CHANGED_FILES=""
          if [ "${{ github.event_name }}" = "push" ]; then
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
              echo "ğŸ“‹ Comparing with previous commit (HEAD~1)"
            else
              echo "âš ï¸  First commit detected - will build all services"
              BUILD_SERVICES="${ALL_SERVICES[@]}"
            fi
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
              echo "ğŸ“‹ Manual trigger - checking recent commit changes"
            else
              CHANGED_FILES=$(git show --name-only --format="" HEAD)
              echo "ğŸ“‹ Manual trigger - analyzing current commit"
            fi
          fi
          
          # ë³€ê²½ëœ íŒŒì¼ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì„œë¹„ìŠ¤ë§Œ ì •í™•íˆ ì°¾ê¸°
          if [ -n "$CHANGED_FILES" ] && [ -z "$BUILD_SERVICES" ]; then
            echo "ğŸ“„ Changed files:"
            echo "$CHANGED_FILES"
            echo ""
            
            # ê° ì„œë¹„ìŠ¤ë³„ë¡œ ì •í™•í•œ ê²½ë¡œ ë§¤ì¹­
            for SERVICE in "${ALL_SERVICES[@]}"; do
              if echo "$CHANGED_FILES" | grep -q "^backend/$SERVICE/"; then
                echo "âœ… Changes detected in: $SERVICE"
                BUILD_SERVICES="$BUILD_SERVICES $SERVICE"
              else
                echo "âšª No changes in: $SERVICE"
              fi
            done
            
            BUILD_SERVICES=$(echo $BUILD_SERVICES | xargs)
            
            # ë°±ì—”ë“œì™€ ë¬´ê´€í•œ ë³€ê²½ì‚¬í•­ë§Œ ìˆëŠ” ê²½ìš°
            if [ -z "$BUILD_SERVICES" ] && ! echo "$CHANGED_FILES" | grep -q "^backend/.*\.java\|^backend/.*/Dockerfile\|^backend/.*/build\.gradle"; then
              echo ""
              echo "â„¹ï¸  No backend service code changes detected"
              echo "ğŸ“‹ Changed files appear to be:"
              echo "$CHANGED_FILES" | grep -E "(\.md$|\.yml$|^\.github|^frontend|^docs)" || echo "Non-service backend files"
              echo ""
              echo "â­ï¸  Skipping Docker build - no service changes found"
              echo "build_services=" >> $GITHUB_ENV
              echo "skip_build=true" >> $GITHUB_ENV
              exit 0
            fi
            
            # ë°±ì—”ë“œ ë³€ê²½ì´ ìˆì§€ë§Œ íŠ¹ì • ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ê°€ ì•„ë‹Œ ê²½ìš° (ê³µí†µ íŒŒì¼ ë“±)
            if [ -z "$BUILD_SERVICES" ] && echo "$CHANGED_FILES" | grep -q "^backend/"; then
              echo ""
              echo "ğŸ¤” Backend changes detected but not in specific service directories"
              echo "ğŸ“‹ Changed backend files:"
              echo "$CHANGED_FILES" | grep "^backend/"
              echo ""
              echo "ğŸ›¡ï¸  Building all services for safety (common files may affect all)"
              BUILD_SERVICES="${ALL_SERVICES[@]}"
            fi
          fi
          
          if [ -z "$BUILD_SERVICES" ]; then
            echo ""
            echo "ğŸ¯ Result: No services need building"
            echo "build_services=" >> $GITHUB_ENV
            echo "skip_build=true" >> $GITHUB_ENV
            exit 0
          fi
          
          echo ""
          echo "ğŸ¯ FINAL DECISION: Building these services only:"
          for SERVICE in $BUILD_SERVICES; do
            echo "  ğŸ”¨ $SERVICE"
          done
          echo ""
          echo "build_services=$BUILD_SERVICES" >> $GITHUB_ENV
          echo "skip_build=false" >> $GITHUB_ENV
          
          # Slack ì•Œë¦¼ì„ ìœ„í•œ ì„œë¹„ìŠ¤ ëª©ë¡ í¬ë§·íŒ…
          FORMATTED_SERVICES=$(echo $BUILD_SERVICES | sed 's/ /, /g')
          echo "formatted_services=$FORMATTED_SERVICES" >> $GITHUB_ENV
          
      - name: Build services
        id: build-services
        if: env.skip_build != 'true' && env.build_services != ''
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # ê³ ìœ ì„±ì„ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ (ë‚´ë¶€ ë¹Œë“œìš©)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BUILD_NUMBER="${{ github.run_number }}"
          
          # ë¹Œë“œëœ ì„œë¹„ìŠ¤ì™€ ë²„ì „ì„ ì €ì¥í•  ë°°ì—´
          BUILT_SERVICES=""
          
          echo "ğŸ—ï¸ Starting Docker build process for selected services..."
          echo ""
          
          for SERVICE in ${{ env.build_services }}; do
            echo "==================== $SERVICE ===================="
            
            # í˜„ì¬ ì„œë¹„ìŠ¤ì˜ ê¸°ì¡´ ë²„ì „ í™•ì¸
            EXISTING_VERSIONS=$(aws ecr describe-images \
              --repository-name kubox \
              --query "imageDetails[].imageTags[]" \
              --output text 2>/dev/null | \
              tr '\t' '\n' | \
              grep "^${SERVICE}-v[0-9]*$" | \
              sed "s/${SERVICE}-v//" | \
              sort -n || echo "")
            
            if [ -z "$EXISTING_VERSIONS" ]; then
              NEXT_VERSION=1
              echo "ğŸ†• First version for $SERVICE: v1"
            else
              LATEST_VERSION=$(echo "$EXISTING_VERSIONS" | tail -1)
              NEXT_VERSION=$((LATEST_VERSION + 1))
              echo "ğŸ“ˆ $SERVICE: v$LATEST_VERSION â†’ v$NEXT_VERSION"
            fi
            
            # ìµœì¢… íƒœê·¸ë“¤
            VERSION_TAG="${SERVICE}-v${NEXT_VERSION}"
            LATEST_TAG="${SERVICE}-latest"
            
            # ì„ì‹œ ê³ ìœ  íƒœê·¸ (ì¶©ëŒ ë°©ì§€ìš©)
            TEMP_TAG="${SERVICE}-temp-${TIMESTAMP}-${BUILD_NUMBER}"
            
            VERSION_URI="$ECR_REGISTRY/kubox:$VERSION_TAG"
            LATEST_URI="$ECR_REGISTRY/kubox:$LATEST_TAG"
            
            echo "ğŸ—ï¸  Building: $VERSION_TAG"
            
            # ë„ì»¤ ë¹Œë“œ (VERSION ì¸ì ì „ë‹¬)
            cd backend/$SERVICE
            
            if docker build --build-arg VERSION="$VERSION_TAG" -t "$TEMP_TAG" .; then
              echo "âœ… Build successful: $SERVICE"
              
              # ë²„ì „ íƒœê·¸ ì ìš© ë° í‘¸ì‹œ
              docker tag "$TEMP_TAG" "$VERSION_URI"
              if docker push "$VERSION_URI"; then
                echo "âœ… Pushed: $VERSION_TAG"
                
                # latest íƒœê·¸ ì ìš© ë° í‘¸ì‹œ
                docker tag "$TEMP_TAG" "$LATEST_URI"
                docker push "$LATEST_URI"
                echo "âœ… Updated: $LATEST_TAG"
                
                # ë¹Œë“œ ì„±ê³µí•œ ì„œë¹„ìŠ¤ ê¸°ë¡
                BUILT_SERVICES="$BUILT_SERVICES $SERVICE:$VERSION_TAG"
                
              else
                echo "âŒ Failed to push: $VERSION_TAG"
              fi
              
              # ì„ì‹œ íƒœê·¸ ì •ë¦¬
              docker rmi "$TEMP_TAG" 2>/dev/null || true
              
            else
              echo "âŒ Build failed: $SERVICE"
            fi
            
            cd ../..
            echo ""
          done

          # ë¹Œë“œ ê²°ê³¼ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
          echo "built_services=$BUILT_SERVICES" >> $GITHUB_ENV
          
          # Slack ì•Œë¦¼ìš© í¬ë§·íŒ…
          FORMATTED_BUILT=$(echo $BUILT_SERVICES | sed 's/ /\\nâ€¢ /g' | sed 's/:/: /g')
          echo "formatted_built_services=$FORMATTED_BUILT" >> $GITHUB_ENV

      - name: ğŸš€ Notify Build Complete
        if: success() && env.skip_build != 'true' && env.built_services != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "",
              "attachments": [{
                "color": "#36a64f",
                "title": "ğŸš€ Docker Images Successfully Built and Pushed to ECR",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "ğŸ¯ Built Services",
                    "value": "${{ env.formatted_services }}",
                    "short": false
                  },
                  {
                    "title": "ğŸ“¦ New Image Tags",
                    "value": "â€¢ ${{ env.formatted_built_services }}",
                    "short": false
                  },
                  {
                    "title": "ğŸª ECR Repository",
                    "value": "`${{ steps.login-ecr.outputs.registry }}/kubox`",
                    "short": false
                  }
                ],
                "footer": "AWS ECR - Image Push Complete",
                "footer_icon": "https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png",
                "ts": $(date +%s)
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: â„¹ï¸  Notify No Changes
        if: env.skip_build == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "",
              "attachments": [{
                "color": "#36a64f",
                "title": "â„¹ï¸ No Docker Build Required",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Branch", 
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "ğŸ“‹ Analysis Result",
                    "value": "âœ… SonarQube analysis completed\nâšª No backend service code changes detected\nâ­ï¸ Skipping Docker image build",
                    "short": false
                  }
                ],
                "footer": "Smart Build Detection",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "ts": $(date +%s)
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: Update Helm Chart
        if: env.skip_build != 'true' && env.built_services != ''
        run: |
          echo "ğŸ”„ Updating Helm Chart with new image tags..."
          
          # Git ì„¤ì •
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # í† í° í™•ì¸
          if [ -z "${{ secrets.HELM_REPO_TOKEN }}" ]; then
            echo "âŒ HELM_REPO_TOKEN is not set - skipping helm chart update"
            exit 0
          fi
          
          # Helm Chart ì €ì¥ì†Œ í´ë¡ 
          if git clone https://${{ secrets.HELM_REPO_TOKEN }}@github.com/Kuboxer/kubox-helm-chart.git helm-repo; then
            echo "âœ… Successfully cloned helm chart repository"
          else
            echo "âŒ Failed to clone helm chart repository - skipping update"
            exit 0
          fi
          
          cd helm-repo
          
          # ë¹Œë“œëœ ê° ì„œë¹„ìŠ¤ì˜ íƒœê·¸ ì—…ë°ì´íŠ¸
          for SERVICE_TAG in ${{ env.built_services }}; do
            SERVICE=$(echo $SERVICE_TAG | cut -d':' -f1)
            TAG=$(echo $SERVICE_TAG | cut -d':' -f2)
            
            echo "ğŸ“ Updating $SERVICE to $TAG"
            
            # values.yamlì—ì„œ í•´ë‹¹ ì„œë¹„ìŠ¤ì˜ íƒœê·¸ ì—…ë°ì´íŠ¸
            case $SERVICE in
              "user-service")
                if [ -f values.yaml ]; then
                  sed -i "s/tag: user-service-v.*/tag: $TAG/" values.yaml
                fi
                ;;
              "product-service")
                if [ -f values.yaml ]; then
                  sed -i "s/tag: product-service-v.*/tag: $TAG/" values.yaml
                fi
                ;;
              "cart-service")
                if [ -f values.yaml ]; then
                  sed -i "s/tag: cart-service-v.*/tag: $TAG/" values.yaml
                fi
                ;;
              "order-service")
                if [ -f values.yaml ]; then
                  sed -i "s/tag: order-service-v.*/tag: $TAG/" values.yaml
                fi
                ;;
              "payment-service")
                if [ -f values.yaml ]; then
                  sed -i "s/tag: payment-service-v.*/tag: $TAG/" values.yaml
                fi
                ;;
            esac
          done
          
          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹ & í‘¸ì‹œ
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Update image tags: ${{ env.built_services }}"
            git push https://${{ secrets.HELM_REPO_TOKEN }}@github.com/Kuboxer/kubox-helm-chart.git main && echo "âœ… Helm chart updated successfully" || echo "âš ï¸  Failed to push helm chart changes"
          else
            echo "â„¹ï¸  No changes to commit"
          fi

  # ìµœì¢… ì•Œë¦¼ - ê¸°ë³¸ ì•Œë¦¼ ëŒ€ì‹  ë§ì¶¤í˜• ì•Œë¦¼
  final-notification:
    name: ğŸ“Š Final Status
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [sonarqube-analysis, manual-approval, build-and-deploy]
    steps:
      - name: ğŸ‰ Notify Workflow Complete
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "",
              "attachments": [{
                "color": "${{ needs.build-and-deploy.result == 'success' && '#36a64f' || (needs.build-and-deploy.result == 'cancelled' && '#ff9500' || '#d73a49') }}",
                "title": "${{ needs.build-and-deploy.result == 'success' && 'ğŸ‰ Deployment Workflow Completed Successfully' || (needs.build-and-deploy.result == 'cancelled' && 'ğŸ›‘ Deployment Workflow Cancelled' || 'âŒ Deployment Workflow Failed') }}",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Triggered by",
                    "value": "${{ github.actor }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "`${{ github.sha }}`".substring(0, 10),
                    "short": true
                  },
                  {
                    "title": "ğŸ“Š Workflow Summary",
                    "value": "â€¢ SonarQube Analysis: ${{ needs.sonarqube-analysis.result == 'success' && 'âœ… Success' || 'âŒ Failed' }}\nâ€¢ Manual Approval: ${{ needs.manual-approval.result == 'success' && 'âœ… Approved' || (needs.manual-approval.result == 'cancelled' && 'ğŸ›‘ Cancelled' || 'âŒ Failed') }}\nâ€¢ Build & Deploy: ${{ needs.build-and-deploy.result == 'success' && 'âœ… Success' || (needs.build-and-deploy.result == 'cancelled' && 'ğŸ›‘ Cancelled' || 'âŒ Failed') }}",
                    "short": false
                  },
                  {
                    "title": "ğŸ”— View Details",
                    "value": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|GitHub Actions Workflow>",
                    "short": false
                  }
                ],
                "footer": "GitHub Actions - Workflow Complete",
                "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                "ts": $(date +%s)
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()
