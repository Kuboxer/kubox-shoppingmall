name: Backend MSA Deploy

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-deploy.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
          
      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
        
      - name: Detect changed services and build
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ì°¾ê¸°
          CHANGED_SERVICES=""
          
          if echo "$CHANGED_FILES" | grep -q "backend/user-service/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES user-service"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "backend/product-service/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES product-service"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "backend/order-service/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES order-service"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "backend/payment-service/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES payment-service"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "backend/cart-service/"; then
            CHANGED_SERVICES="$CHANGED_SERVICES cart-service"
          fi
          
          CHANGED_SERVICES=$(echo $CHANGED_SERVICES | xargs)
          
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "No service changes detected. Skipping build."
            exit 0
          fi
          
          echo "Changed services: $CHANGED_SERVICES"
          
          for SERVICE in $CHANGED_SERVICES; do
            echo "=== Processing $SERVICE ==="
            
            # í˜„ìž¬ ECRì˜ ëª¨ë“  íƒœê·¸ ì¡°íšŒ
            echo "Current ECR tags for $SERVICE:"
            ALL_TAGS=$(aws ecr describe-images \
              --repository-name kubox \
              --query "imageDetails[?contains(imageTags, '${SERVICE}')].imageTags[]" \
              --output text 2>/dev/null | tr '\t' '\n' | sort || echo "")
            
            echo "$ALL_TAGS"
            
            # í˜„ìž¬ ì„œë¹„ìŠ¤ì˜ ë²„ì „ íƒœê·¸ë“¤ë§Œ ì¶”ì¶œ (ì •í™•í•œ íŒ¨í„´)
            VERSION_TAGS=$(echo "$ALL_TAGS" | grep "^${SERVICE}-v[0-9]*$" | sort -V || echo "")
            
            echo "Version tags for $SERVICE:"
            echo "$VERSION_TAGS"
            
            # ìµœê³  ë²„ì „ ì°¾ê¸°
            if [ -z "$VERSION_TAGS" ]; then
              NEXT_VERSION=1
              echo "No existing versions found. Starting with v1"
            else
              # ê°€ìž¥ ë†’ì€ ë²„ì „ ë²ˆí˜¸ ì¶”ì¶œ
              LATEST_VERSION=$(echo "$VERSION_TAGS" | sed "s/${SERVICE}-v//" | sort -n | tail -1)
              NEXT_VERSION=$((LATEST_VERSION + 1))
              echo "Latest version: v$LATEST_VERSION"
              echo "Next version will be: v$NEXT_VERSION"
            fi
            
            # ìƒˆ ë²„ì „ íƒœê·¸ ìƒì„±
            NEW_TAG="${SERVICE}-v${NEXT_VERSION}"
            IMAGE_URI="$ECR_REGISTRY/kubox:$NEW_TAG"
            
            echo "Building new image with tag: $NEW_TAG"
            
            # ê³ ìœ í•œ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ìƒì„± (íƒœê·¸ ì¶©ëŒ ë°©ì§€)
            BUILD_CONTEXT="build-${SERVICE}-$(date +%s)"
            mkdir -p "$BUILD_CONTEXT"
            cp -r backend/$SERVICE/* "$BUILD_CONTEXT/"
            
            # ë¹Œë“œ ê³ ìœ ì„± ë³´ìž¥
            echo "BUILD_TIME=$(date)" >> "$BUILD_CONTEXT/.buildinfo"
            echo "BUILD_VERSION=$NEW_TAG" >> "$BUILD_CONTEXT/.buildinfo"
            echo "COMMIT_SHA=${{ github.sha }}" >> "$BUILD_CONTEXT/.buildinfo"
            
            # ë„ì»¤ ë¹Œë“œ
            cd "$BUILD_CONTEXT"
            if docker build -t "$IMAGE_URI" .; then
              echo "âœ… Build successful for $NEW_TAG"
              
              # ì´ë¯¸ì§€ í‘¸ì‹œ
              if docker push "$IMAGE_URI"; then
                echo "âœ… Successfully pushed $NEW_TAG"
                
                # latest íƒœê·¸ëŠ” ë³„ë„ ì´ë¯¸ì§€ë¡œ ì²˜ë¦¬
                LATEST_TAG="${SERVICE}-latest"
                LATEST_URI="$ECR_REGISTRY/kubox:$LATEST_TAG"
                
                # latest íƒœê·¸ë¥¼ ìƒˆ ì´ë¯¸ì§€ì— ì ìš©
                docker tag "$IMAGE_URI" "$LATEST_URI"
                docker push "$LATEST_URI"
                echo "âœ… Updated latest tag to point to $NEW_TAG"
                
                # ê²€ì¦: ìƒˆë¡œ ìƒì„±ëœ íƒœê·¸ í™•ì¸
                echo "Verifying new tag..."
                aws ecr describe-images \
                  --repository-name kubox \
                  --image-ids imageTag="$NEW_TAG" \
                  --query "imageDetails[0].imageTags" \
                  --output text 2>/dev/null && echo "âœ… Tag verified in ECR"
                
              else
                echo "âŒ Failed to push $NEW_TAG"
              fi
            else
              echo "âŒ Build failed for $SERVICE"
            fi
            
            cd ..
            rm -rf "$BUILD_CONTEXT"
            
            echo "âœ… Completed processing $SERVICE"
            echo "---"
          done
          
          echo ""
          echo "ðŸŽ‰ Build completed!"
          echo "Changed services: $CHANGED_SERVICES"
          
      - name: Final verification
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          echo "Final ECR state verification..."
          
          # ëª¨ë“  kubox ì´ë¯¸ì§€ íƒœê·¸ ì¡°íšŒ
          echo "All current tags in kubox repository:"
          aws ecr describe-images \
            --repository-name kubox \
            --query "imageDetails[].imageTags[]" \
            --output text 2>/dev/null | tr '\t' '\n' | sort || echo "No images found"
